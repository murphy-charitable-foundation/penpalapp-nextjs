<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firestore PenPal Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .log-entry {
        padding: 6px;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
      }
      .log-entry.error {
        color: red;
        font-weight: bold;
      }
      .log-entry.success {
        color: green;
      }
      .log-entry.info {
        color: blue;
      }
      label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: 600;
      }
      input[type="text"],
      textarea,
      input[type="password"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        min-height: 100px;
      }
      button {
        background-color: #4a90e2;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        margin-right: 5px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #357abd;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #logArea {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        height: 300px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-4 md:p-8">
    <div class="container mx-auto max-w-2xl bg-white p-6 rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold mb-6 text-center text-gray-700">
        PenPal Firestore Test Script
      </h1>

      <div class="mb-6 p-4 border border-blue-200 rounded-md bg-blue-50">
        <h2 class="text-xl font-semibold mb-3 text-blue-700">
          1. Firebase Configuration
        </h2>
        <label for="firebaseConfig">Firebase Config (JSON):</label>
        <textarea
          id="firebaseConfig"
          rows="6"
          placeholder='{
  "apiKey": "YOUR_API_KEY",
  "authDomain": "YOUR_PROJECT_ID.firebaseapp.com",
  "projectId": "YOUR_PROJECT_ID",
  "storageBucket": "YOUR_PROJECT_ID.appspot.com",
  "messagingSenderId": "YOUR_MESSAGING_SENDER_ID",
  "appId": "YOUR_APP_ID"
}'
          class="font-mono text-sm"></textarea>
        <button id="initFirebase" class="bg-green-500 hover:bg-green-600">
          Initialize Firebase & Sign In Anonymously
        </button>
        <p id="authStatus" class="mt-2 text-sm text-gray-600">
          Status: Not Authenticated
        </p>
      </div>

      <div class="mb-6 p-4 border border-yellow-200 rounded-md bg-yellow-50">
        <h2 class="text-xl font-semibold mb-3 text-yellow-700">
          2. Test Parameters
        </h2>
        <label for="letterboxId">Letterbox ID:</label>
        <input
          type="text"
          id="letterboxId"
          placeholder="e.g., lMQlIGhJ5eLyiI4HXEQt" />

        <label for="actingUserId">"Acting As" User ID (Sender):</label>
        <input
          type="text"
          id="actingUserId"
          placeholder="e.g., k6sZhewFf2avTreRdcwGD4BiHY42" />
      </div>

      <div class="mb-6 p-4 border border-purple-200 rounded-md bg-purple-50">
        <h2 class="text-xl font-semibold mb-3 text-purple-700">
          3. Message Operations
        </h2>
        <label for="messageContent">Message Content:</label>
        <textarea
          id="messageContent"
          placeholder="Type your message here..."></textarea>
        <input type="hidden" id="currentDraftId" />

        <button id="fetchDraftBtn" disabled>Fetch/Load User's Draft</button>
        <button id="saveDraftBtn" disabled>Save Draft</button>
        <button id="sendMessageBtn" disabled>Send Message</button>
        <button
          id="deleteDraftBtn"
          disabled
          class="bg-red-500 hover:bg-red-600">
          Delete Current Draft
        </button>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-700">4. Logs</h2>
        <div id="logArea">
          <div class="log-entry info">Please initialize Firebase first.</div>
        </div>
        <button id="clearLogBtn" class="bg-gray-500 hover:bg-gray-600">
          Clear Log
        </button>
      </div>
    </div>

    <script type="module">
      // IMPORTANT: Replace with your actual Firebase SDK versions if needed
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        collection,
        query,
        where,
        getDocs,
        serverTimestamp,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      let app;
      let auth;
      let db;
      let currentFirebaseUser = null; // Firebase authenticated user
      let actingUserRef = null; // Reference to the user who is 'sending' the message

      const firebaseConfigInput = document.getElementById("firebaseConfig");
      const initFirebaseBtn = document.getElementById("initFirebase");
      const authStatusEl = document.getElementById("authStatus");

      const letterboxIdInput = document.getElementById("letterboxId");
      const actingUserIdInput = document.getElementById("actingUserId");

      const messageContentInput = document.getElementById("messageContent");
      const currentDraftIdInput = document.getElementById("currentDraftId");

      const fetchDraftBtn = document.getElementById("fetchDraftBtn");
      const saveDraftBtn = document.getElementById("saveDraftBtn");
      const sendMessageBtn = document.getElementById("sendMessageBtn");
      const deleteDraftBtn = document.getElementById("deleteDraftBtn");

      const logArea = document.getElementById("logArea");
      const clearLogBtn = document.getElementById("clearLogBtn");

      // --- Logging ---
      function log(message, type = "info") {
        console.log(`[${type.toUpperCase()}] ${message}`);
        const entry = document.createElement("div");
        entry.classList.add("log-entry", type);
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logArea.appendChild(entry);
        logArea.scrollTop = logArea.scrollHeight; // Auto-scroll
      }

      clearLogBtn.addEventListener("click", () => {
        logArea.innerHTML = "";
        log("Log cleared.", "info");
      });

      // --- Firebase Initialization and Auth ---
      initFirebaseBtn.addEventListener("click", async () => {
        try {
          const configString = firebaseConfigInput.value.trim();
          if (!configString) {
            log("Firebase config is empty. Please provide it.", "error");
            return;
          }
          const firebaseConfig = JSON.parse(configString);

          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          log("Firebase Initialized. Attempting anonymous sign-in...", "info");

          onAuthStateChanged(auth, (user) => {
            if (user) {
              currentFirebaseUser = user;
              authStatusEl.textContent = `Status: Authenticated anonymously (UID: ${user.uid})`;
              authStatusEl.className = "mt-2 text-sm text-green-600";
              log(
                `Successfully signed in anonymously. UID: ${user.uid}`,
                "success"
              );
              enableActionButtons(true);
            } else {
              currentFirebaseUser = null;
              authStatusEl.textContent = "Status: Not Authenticated";
              authStatusEl.className = "mt-2 text-sm text-red-600";
              log("User signed out or not authenticated.", "info");
              enableActionButtons(false);
            }
          });

          await signInAnonymously(auth);
        } catch (error) {
          log(
            `Error initializing Firebase or signing in: ${error.message}`,
            "error"
          );
          console.error(error);
          authStatusEl.textContent = "Status: Authentication Failed";
          authStatusEl.className = "mt-2 text-sm text-red-600";
        }
      });

      function enableActionButtons(enable) {
        fetchDraftBtn.disabled = !enable;
        saveDraftBtn.disabled = !enable;
        sendMessageBtn.disabled = !enable;
        deleteDraftBtn.disabled = !enable;
      }

      // --- Core Logic ---
      function getRequiredIds() {
        const letterboxId = letterboxIdInput.value.trim();
        const actingUserId = actingUserIdInput.value.trim();

        if (!currentFirebaseUser) {
          log(
            "Not authenticated. Please initialize Firebase and sign in.",
            "error"
          );
          return null;
        }
        if (!db) {
          log("Firestore not initialized.", "error");
          return null;
        }
        if (!letterboxId) {
          log("Letterbox ID is required.", "error");
          return null;
        }
        if (!actingUserId) {
          log('"Acting As" User ID is required.', "error");
          return null;
        }
        actingUserRef = doc(db, "users", actingUserId);
        return { letterboxId, actingUserId, actingUserRef };
      }

      // Fetch existing draft for the actingUser in the letterbox
      fetchDraftBtn.addEventListener("click", async () => {
        const ids = getRequiredIds();
        if (!ids) return;

        const { letterboxId, actingUserRef } = ids;
        log(
          `Fetching draft for user ${actingUserRef.path} in letterbox ${letterboxId}...`,
          "info"
        );

        try {
          const lettersColRef = collection(
            db,
            "letterbox",
            letterboxId,
            "letters"
          );
          const q = query(
            lettersColRef,
            where("sent_by", "==", actingUserRef),
            where("status", "==", "draft")
          );

          const querySnapshot = await getDocs(q);
          let foundDraft = null;
          let draftCount = 0;

          querySnapshot.forEach((docSnap) => {
            draftCount++;
            if (!foundDraft) {
              // Take the first one if multiple (though ideally there should be one)
              foundDraft = { id: docSnap.id, ...docSnap.data() };
            }
            log(
              `Found draft document: ID=${docSnap.id}, Content="${
                docSnap.data().content
              }"`,
              "info"
            );
          });

          if (draftCount > 1) {
            log(
              `WARNING: Found ${draftCount} drafts for this user in this letterbox. This might indicate an issue. Using the first one found.`,
              "error"
            );
          }

          if (foundDraft) {
            messageContentInput.value = foundDraft.content || "";
            currentDraftIdInput.value = foundDraft.id;
            log(
              `Draft loaded: ID=${foundDraft.id}. Content: "${foundDraft.content}"`,
              "success"
            );
          } else {
            messageContentInput.value = "";
            currentDraftIdInput.value = "";
            log(
              "No existing draft found for this user in this letterbox. Ready to create a new one.",
              "info"
            );
          }
        } catch (error) {
          log(`Error fetching draft: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Save current content as a draft
      saveDraftBtn.addEventListener("click", async () => {
        const ids = getRequiredIds();
        if (!ids) return;

        const { letterboxId, actingUserRef } = ids;
        const content = messageContentInput.value.trim(); // Trim content for saving
        const existingDraftId = currentDraftIdInput.value;

        if (!content && existingDraftId) {
          log(
            `Content is empty. If you want to delete the draft, use the "Delete Current Draft" button. Not saving empty content over existing draft.`,
            "info"
          );
          // Or, call deleteDraftBtn's logic here if auto-delete on empty save is desired
          // await deleteDraftById(existingDraftId, letterboxId);
          return;
        }
        if (!content && !existingDraftId) {
          log("Content is empty. Nothing to save as a new draft.", "info");
          return;
        }

        const draftData = {
          sent_by: actingUserRef,
          content: content,
          status: "draft",
          created_at: serverTimestamp(), // Will be set by server on creation
          updated_at: serverTimestamp(), // Will be set by server
          deleted: null,
        };

        try {
          const lettersColRef = collection(
            db,
            "letterbox",
            letterboxId,
            "letters"
          );
          if (existingDraftId) {
            // Update existing draft
            const draftRef = doc(lettersColRef, existingDraftId);
            // For updates, created_at should ideally not change unless it's a new policy
            // The user's code updates created_at on draft save if it exists. Let's mimic that for consistency.
            // However, if draft.created_at already exists, it's better to preserve it.
            // Let's fetch the draft first to preserve created_at if it exists.
            const currentDocSnap = await getDoc(draftRef);
            const updateData = {
              content: content,
              status: "draft",
              updated_at: serverTimestamp(),
              // Preserve created_at if it exists, otherwise set it
              created_at:
                currentDocSnap.exists() && currentDocSnap.data().created_at
                  ? currentDocSnap.data().created_at
                  : serverTimestamp(),
            };

            await updateDoc(draftRef, updateData);
            log(`Draft updated: ID=${existingDraftId}`, "success");
          } else {
            // Create new draft
            // First, ensure no other draft exists for this user to avoid multiple drafts
            const q = query(
              lettersColRef,
              where("sent_by", "==", actingUserRef),
              where("status", "==", "draft")
            );
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
              log(
                `Error: An existing draft by this user was found (ID: ${querySnapshot.docs[0].id}). Cannot create another. Please fetch and update it, or delete it.`,
                "error"
              );
              currentDraftIdInput.value = querySnapshot.docs[0].id; // Set it so user can update/delete
              messageContentInput.value = querySnapshot.docs[0].data().content;
              return;
            }

            const newDraftRef = doc(lettersColRef); // Auto-generate ID
            await setDoc(newDraftRef, draftData);
            currentDraftIdInput.value = newDraftRef.id;
            log(`New draft saved: ID=${newDraftRef.id}`, "success");
          }
        } catch (error) {
          log(`Error saving draft: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Send the message (convert draft to sent, or create new sent message)
      sendMessageBtn.addEventListener("click", async () => {
        const ids = getRequiredIds();
        if (!ids) return;

        const { letterboxId, actingUserRef } = ids;
        const content = messageContentInput.value.trim();
        const existingDraftId = currentDraftIdInput.value;

        if (!content) {
          log("Cannot send an empty message.", "error");
          return;
        }

        const messageData = {
          sent_by: actingUserRef,
          content: content,
          status: "sent",
          // created_at for a sent message should be the time it's sent.
          // If updating a draft, its original created_at (as a draft) might be different.
          // The user's code sets created_at to currentTime when sending.
          created_at: serverTimestamp(),
          updated_at: serverTimestamp(), // Also update updated_at
          deleted: null,
        };

        try {
          const lettersColRef = collection(
            db,
            "letterbox",
            letterboxId,
            "letters"
          );
          let messageIdToLog;

          if (existingDraftId) {
            // This draft was loaded and is now being sent
            const draftRef = doc(lettersColRef, existingDraftId);
            // Ensure the loaded draft is indeed by the current acting user and is a draft
            const docSnap = await getDoc(draftRef);
            if (
              docSnap.exists() &&
              docSnap.data().status === "draft" &&
              docSnap.data().sent_by.path === actingUserRef.path
            ) {
              await updateDoc(draftRef, messageData);
              log(
                `Message sent by updating draft: ID=${existingDraftId}`,
                "success"
              );
              messageIdToLog = existingDraftId;
            } else {
              log(
                `Loaded draft (ID: ${existingDraftId}) is not valid for sending (not found, not a draft, or not by this user). Attempting to send as new message.`,
                "error"
              );
              // Fall through to create new message
              const newMessageRef = doc(lettersColRef);
              await setDoc(newMessageRef, messageData);
              log(
                `Message sent as new document: ID=${newMessageRef.id}`,
                "success"
              );
              messageIdToLog = newMessageRef.id;
            }
          } else {
            // No draft was loaded, sending a new message directly
            const newMessageRef = doc(lettersColRef);
            await setDoc(newMessageRef, messageData);
            log(
              `Message sent as new document: ID=${newMessageRef.id}`,
              "success"
            );
            messageIdToLog = newMessageRef.id;
          }

          // Clear message input and draft ID after sending
          messageContentInput.value = "";
          currentDraftIdInput.value = "";
        } catch (error) {
          log(`Error sending message: ${error.message}`, "error");
          console.error(error);
        }
      });

      // Delete current draft
      deleteDraftBtn.addEventListener("click", async () => {
        const ids = getRequiredIds();
        if (!ids) return;
        const existingDraftId = currentDraftIdInput.value;
        if (!existingDraftId) {
          log("No draft ID loaded to delete.", "error");
          return;
        }
        await deleteDraftById(
          existingDraftId,
          ids.letterboxId,
          ids.actingUserRef
        );
      });

      async function deleteDraftById(
        draftId,
        letterboxId,
        actingUserRefForCheck
      ) {
        log(`Attempting to delete draft ID: ${draftId}...`, "info");
        try {
          const draftRef = doc(
            db,
            "letterbox",
            letterboxId,
            "letters",
            draftId
          );
          // Optional: Verify it's actually a draft by the current user before deleting
          const docSnap = await getDoc(draftRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            if (
              data.status === "draft" &&
              data.sent_by.path === actingUserRefForCheck.path
            ) {
              await deleteDoc(draftRef);
              log(`Draft ID: ${draftId} deleted successfully.`, "success");
              messageContentInput.value = "";
              currentDraftIdInput.value = "";
            } else {
              log(
                `Document ID: ${draftId} is not a deletable draft for this user (status: ${data.status}, sent_by: ${data.sent_by.path}).`,
                "error"
              );
            }
          } else {
            log(`Draft ID: ${draftId} not found for deletion.`, "error");
          }
        } catch (error) {
          log(`Error deleting draft ${draftId}: ${error.message}`, "error");
          console.error(error);
        }
      }

      // Initial state
      enableActionButtons(false);
      firebaseConfigInput.value = `{
  "apiKey": "YOUR_API_KEY",
  "authDomain": "YOUR_PROJECT_ID.firebaseapp.com",
  "projectId": "YOUR_PROJECT_ID",
  "storageBucket": "YOUR_PROJECT_ID.appspot.com",
  "messagingSenderId": "YOUR_MESSAGING_SENDER_ID",
  "appId": "YOUR_APP_ID"
}`;
      log(
        "Script loaded. Please provide Firebase config and initialize.",
        "info"
      );
    </script>
  </body>
</html>
